# QGIS Setup Guide for AgriGIS Portal

## Overview

This guide provides step-by-step instructions for setting up QGIS to work with the AgriGIS Portal's Supabase PostgreSQL/PostGIS database. You'll learn how to connect QGIS to your cloud database, create annotation layers for pinmarks and farm boundaries, and export spatial data.

## Prerequisites

- ✅ QGIS installed (version 3.x recommended)
- ✅ PostGIS extension enabled in Supabase (run `postgis_setup.sql` first)
- ✅ Supabase database credentials
- ✅ Internet connection (QGIS needs to connect to cloud database)

---

## Part 1: Connecting QGIS to Supabase PostgreSQL

### Step 1: Gather Database Credentials

From your Supabase project dashboard:

1. Go to **Settings** → **Database**
2. Note down the following connection details:
   - **Host**: `db.[your-project-ref].supabase.co`
   - **Port**: `5432`
   - **Database**: `postgres`
   - **User**: `postgres`
   - **Password**: Your database password

### Step 2: Create PostgreSQL Connection in QGIS

1. Open **QGIS Desktop**
2. In the **Browser Panel** (left side), right-click on **PostGIS**
3. Select **New Connection...**

4. Fill in the connection details:
   ```
   Name:           AgriGIS Supabase
   Host:           db.[your-project-ref].supabase.co
   Port:           5432
   Database:       postgres
   SSL mode:       require (IMPORTANT!)
   Username:       postgres
   Password:       [your-database-password]
   ```

5. Check **☑ Store** for username and password (optional, for convenience)
6. Click **Test Connection** to verify
7. If successful, click **OK**

> [!IMPORTANT]
> Always use **SSL mode: require** when connecting to Supabase for security.

### Step 3: Verify Connection

1. In the **Browser Panel**, expand **PostGIS** → **AgriGIS Supabase**
2. You should see the `public` schema
3. Expand `public` to see tables including:
   - `registrants`
   - `farm_parcels`
   - `pinmark_locations` (new)
   - `farm_boundaries` (new)

---

## Part 2: Creating Pinmark Annotation Layer

### Step 4: Add Base Map Layer

1. In QGIS, go to **Browser Panel** → **XYZ Tiles**
2. Right-click **XYZ Tiles** → **New Connection**
3. Add OpenStreetMap:
   ```
   Name: OpenStreetMap
   URL:  https://tile.openstreetmap.org/{z}/{x}/{y}.png
   ```
4. Double-click **OpenStreetMap** to add it to the map

### Step 5: Set Project CRS

1. In the bottom-right corner, click the **CRS button** (shows current projection)
2. Search for and select **EPSG:4326 - WGS 84**
3. Click **OK**

> [!TIP]
> Always use EPSG:4326 for consistency with the database and web mapping libraries.

### Step 6: Create Pinmark Layer from Database

**Option A: Load Existing Pinmarks**

1. In **Browser Panel**, navigate to:
   ```
   PostGIS → AgriGIS Supabase → public → pinmark_locations
   ```
2. Double-click `pinmark_locations` to add it to the map
3. The layer will appear in the **Layers Panel**

**Option B: Create New Pinmark Layer for Annotation**

1. Go to **Layer** → **Create Layer** → **New Shapefile Layer**
2. Configure:
   ```
   File name:        [Choose a temporary location, e.g., Desktop/pinmarks_temp.shp]
   Geometry type:    Point
   CRS:              EPSG:4326 - WGS 84
   ```
3. Add fields:
   ```
   - location_name (Text, length 255)
   - notes (Text, length 500)
   ```
4. Click **OK**

### Step 7: Create Pinmarks (GPS Points)

1. Select the pinmark layer in **Layers Panel**
2. Click **Toggle Editing** button (pencil icon) in toolbar
3. Click **Add Point Feature** button (point icon)
4. Click on the map where you want to place a pinmark
5. In the attribute form, enter:
   - `location_name`: e.g., "Juan Dela Cruz Home"
   - `notes`: Any additional information
6. Click **OK**
7. Repeat for all pinmark locations
8. Click **Save Layer Edits** (floppy disk icon)
9. Click **Toggle Editing** again to finish

### Step 8: Export Pinmarks to Database

1. Right-click on your pinmark layer → **Export** → **Save Features As...**
2. Configure:
   ```
   Format:           PostGIS
   Connection:       AgriGIS Supabase
   Schema:           public
   Table:            pinmark_locations
   Geometry column:  location
   CRS:              EPSG:4326
   ```
3. In **Layer Options**, map fields:
   ```
   location_name → location_name
   notes → notes
   ```
4. Check **☑ Append to existing layer** (if adding to existing data)
5. Click **OK**

> [!NOTE]
> The `created_at`, `updated_at`, and `id` fields will be auto-generated by the database.

---

## Part 3: Creating Farm Boundary Polygon Layer

### Step 9: Create Polygon Layer

**Option A: Load Existing Boundaries**

1. In **Browser Panel**, navigate to:
   ```
   PostGIS → AgriGIS Supabase → public → farm_boundaries
   ```
2. Double-click `farm_boundaries` to add it to the map

**Option B: Create New Polygon Layer for Annotation**

1. Go to **Layer** → **Create Layer** → **New Shapefile Layer**
2. Configure:
   ```
   File name:        [e.g., Desktop/farm_polygons_temp.shp]
   Geometry type:    Polygon
   CRS:              EPSG:4326 - WGS 84
   ```
3. Add fields:
   ```
   - notes (Text, length 500)
   ```
4. Click **OK**

### Step 10: Draw Farm Boundaries

1. Select the polygon layer
2. Click **Toggle Editing** (pencil icon)
3. Click **Add Polygon Feature** button (polygon icon)
4. Click points around the farm boundary on the map
5. Right-click to finish the polygon
6. Fill in attributes in the form
7. Click **OK**
8. Repeat for all farm boundaries
9. Save edits and toggle editing off

> [!TIP]
> **Digitizing Tips:**
> - Zoom in close for accuracy
> - Use satellite imagery as background (add via QuickMapServices plugin)
> - Hold **Ctrl** while clicking to enable snapping
> - Use **Advanced Digitizing Toolbar** for precise measurements

### Step 11: Export Polygons to Database

1. Right-click on polygon layer → **Export** → **Save Features As...**
2. Configure:
   ```
   Format:           PostGIS
   Connection:       AgriGIS Supabase
   Schema:           public
   Table:            farm_boundaries
   Geometry column:  boundary
   CRS:              EPSG:4326
   ```
3. Check **☑ Append to existing layer** if needed
4. Click **OK**

> [!IMPORTANT]
> The `area_hectares` and `perimeter_meters` fields will be **auto-calculated** by the database trigger. Do NOT manually set these values.

---

## Part 4: Verification and Best Practices

### Step 12: Verify Data in Supabase

1. Open **Supabase Dashboard** → **Table Editor**
2. Check `pinmark_locations` table:
   - Verify new rows appear
   - Check that `location` column has geometry data
   - Verify `area_hectares` is NULL (correct for points)

3. Check `farm_boundaries` table:
   - Verify new rows appear
   - Check that `boundary` column has geometry data
   - **Verify `area_hectares` was auto-calculated** (should be a number, not NULL)

### Step 13: View in Web App

1. Open your AgriGIS Portal web app
2. Navigate to **GIS Map** page
3. Toggle to **Location Map** → pinmarks should appear
4. Toggle to **Farm Map** → polygons should appear

---

## Best Practices

### Coordinate System

✅ **Always use EPSG:4326 (WGS 84)**
- This is the standard for web mapping
- Matches Leaflet, Google Maps, OpenStreetMap
- Required for ST_Area calculations to work correctly

### Data Quality

1. **Avoid self-intersecting polygons**
   - Use **Vector** → **Geometry Tools** → **Check Validity** to verify
   - Fix with **Vector** → **Geometry Tools** → **Fix Geometries**

2. **Avoid overlapping farm boundaries**
   - One farm = one polygon
   - If multiple parcels, create separate polygons

3. **Accurate pinmarks**
   - Place pinmark at actual farmer residence or farm entrance
   - Use satellite imagery for reference

### Satellite Imagery for Reference

Install **QuickMapServices** plugin:

1. **Plugins** → **Manage and Install Plugins**
2. Search for "QuickMapServices"
3. Click **Install Plugin**
4. Go to **Web** → **QuickMapServices** → **Settings**
5. Click **Get contributed pack**
6. Now access: **Web** → **QuickMapServices** → **Google** → **Google Satellite**

---

## Common Issues and Troubleshooting

### Issue: "Connection Failed"

**Solution:**
- Verify Supabase database is active
- Check internet connection
- Ensure SSL mode is set to "require"
- Verify host, port, username, password are correct
- Check Supabase dashboard for connection pooling limits

### Issue: "Area not calculated automatically"

**Solution:**
- Verify `postgis_setup.sql` was run successfully
- Check trigger exists:
  ```sql
  SELECT trigger_name FROM information_schema.triggers
  WHERE event_object_table = 'farm_boundaries';
  ```
- Manually recalculate with UPDATE query if needed

### Issue: "Geometries not showing in web app"

**Solution:**
- Verify CRS is EPSG:4326
- Check geometry column names match: `location` for points, `boundary` for polygons
- Verify data in Supabase Table Editor
- Check browser console for JavaScript errors

### Issue: "Permission denied when saving"

**Solution:**
- Ensure your database user has INSERT/UPDATE permissions
- Check Supabase RLS (Row Level Security) policies
- Verify authenticated role has access:
  ```sql
  GRANT INSERT, UPDATE ON pinmark_locations TO authenticated;
  GRANT INSERT, UPDATE ON farm_boundaries TO authenticated;
  ```

---

## Advanced: Batch Import from GPS Device

If you have GPS data from field surveys (GPX, CSV, etc.):

1. **Import GPS File**:
   - **Layer** → **Add Layer** → **Add Delimited Text Layer** (for CSV)
   - Or **Add Vector Layer** (for GPX, KML, GeoJSON)

2. **Reproject if needed**:
   - Right-click layer → **Export** → **Save Features As...**
   - Set **CRS** to EPSG:4326

3. **Upload to Database** (same as Step 8 or Step 11)

---

## Workflow Summary

```
┌─────────────────────┐
│  1. Connect QGIS    │
│  to Supabase        │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│  2. Add Base Map    │
│  (OpenStreetMap)    │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│  3. Create/Draw     │
│  Pinmarks/Polygons  │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│  4. Export to DB    │
│  (PostGIS)          │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│  5. Verify in Web   │
│  App & Supabase     │
└─────────────────────┘
```

---

## Next Steps

After completing this setup:

1. ✅ Pinmarks and polygons are now in the database
2. ✅ Navigate to **Set Pinmark Info** page in the web app to attach registrant data
3. ✅ Navigate to **Set Farm Parcel Info** page to attach farm parcel data
4. ✅ View combined data in **GIS Map** page

---

## Support

For more information:
- **QGIS Documentation**: https://docs.qgis.org/
- **PostGIS Documentation**: https://postgis.net/documentation/
- **Supabase PostGIS Guide**: https://supabase.com/docs/guides/database/extensions/postgis

**Need Help?** Contact your AgriGIS Portal administrator or development team.
